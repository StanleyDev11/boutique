<!DOCTYPE html>
<html lang="fr" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion des Caisses</title>
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body class="bg-gray-50">

<div th:replace="~{fragments/tailwind-header :: tailwind-header(pageTitle='Gestion des Caisses')}"></div>

<div class="w-full px-4 sm:px-6 lg:px-8 py-8">
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900 flex items-center">
            <i class="fas fa-cash-register text-blue-600 mr-3"></i>
            Gestion des Caisses
        </h1>
        <p class="text-gray-600 mt-2">Gérez les caisses, consultez les sessions ouvertes et l'historique des clôtures.</p>
    </div>

    <!-- Tabs Navigation -->
    <div class="mb-6 border-b border-gray-200">
        <ul class="flex flex-wrap -mb-px text-sm font-medium text-center" id="myTab" role="tablist">
            <li class="mr-2" role="presentation">
                <button class="inline-block p-4 border-b-2 rounded-t-lg" id="caisses-tab" data-tabs-target="#caisses" type="button" role="tab" aria-controls="caisses" aria-selected="true">Postes de Caisse</button>
            </li>
            <li class="mr-2" role="presentation">
                <button class="inline-block p-4 border-b-2 rounded-t-lg hover:text-gray-600 hover:border-gray-300" id="open-sessions-tab" data-tabs-target="#open-sessions" type="button" role="tab" aria-controls="open-sessions" aria-selected="false">Sessions Ouvertes</button>
            </li>
            <li role="presentation">
                <button class="inline-block p-4 border-b-2 rounded-t-lg hover:text-gray-600 hover:border-gray-300" id="closed-sessions-tab" data-tabs-target="#closed-sessions" type="button" role="tab" aria-controls="closed-sessions" aria-selected="false">Sessions Fermées</button>
            </li>
        </ul>
    </div>

    <!-- Tabs Content -->
    <div id="myTabContent">
        <!-- Postes de Caisse Tab -->
        <div class="p-4 rounded-lg bg-gray-50" id="caisses" role="tabpanel" aria-labelledby="caisses-tab">
            <div class="flex justify-between items-center mb-6">
                <button onclick="openCaisseModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-xl flex items-center justify-center font-semibold shadow-lg">
                    <i class="fas fa-plus-circle mr-3 text-lg"></i>
                    Nouvelle Caisse
                </button>
                <form th:action="@{/gestion-caisses}" method="get" class="flex items-center">
                    <input type="hidden" name="tab" value="caisses">
                    <div class="relative">
                        <input type="search" name="caisseKeyword" th:value="${caisseKeyword}" placeholder="Rechercher par nom..." class="form-input pl-10 pr-4 py-2 border rounded-lg">
                        <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                    </div>
                    <button type="submit" class="ml-2 px-4 py-2 bg-gray-800 text-white rounded-lg hover:bg-gray-900">Rechercher</button>
                </form>
            </div>

            <div class="bg-white shadow-md rounded-2xl overflow-hidden">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"><i class="fas fa-tag mr-2"></i>Nom</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"><i class="fas fa-toggle-on mr-2"></i>Statut</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider"><i class="fas fa-cogs mr-2"></i>Actions</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        <tr th:each="caisse : ${caisses}">
                            <td class="px-6 py-4 whitespace-nowrap" th:text="${caisse.nom}"></td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span th:text="${caisse.active ? 'Active' : 'Inactive'}"
                                      th:class="${caisse.active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}"
                                      class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full">
                                </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                <div class="flex justify-end items-center space-x-2">
                                    <button th:onclick="|openCaisseModal(${caisse.id})|" title="Modifier" class="text-blue-600 hover:text-blue-900 bg-blue-50 hover:bg-blue-100 p-3 rounded-lg transition duration-200"><i class="fas fa-edit"></i></button>

                                    <form th:id="|activateForm-${caisse.id}|" th:action="@{/gestion-caisses/activate/{id}(id=${caisse.id})}" method="post" class="inline">
                                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                                        <button type="button" th:if="${!caisse.active}" 
                                                th:attr="data-caisse-id=${caisse.id}, data-caisse-name=${caisse.nom}, data-action='activate'"
                                                onclick="confirmToggleState(this.getAttribute('data-caisse-id'), this.getAttribute('data-caisse-name'), this.getAttribute('data-action'))"
                                                title="Activer" class="text-green-600 hover:text-green-900 bg-green-50 hover:bg-green-100 p-3 rounded-lg transition duration-200"><i class="fas fa-check-circle"></i></button>
                                    </form>

                                    <form th:id="|deactivateForm-${caisse.id}|" th:action="@{/gestion-caisses/deactivate/{id}(id=${caisse.id})}" method="post" class="inline">
                                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                                        <button type="button" th:if="${caisse.active}"
                                                th:attr="data-caisse-id=${caisse.id}, data-caisse-name=${caisse.nom}, data-action='deactivate'"
                                                onclick="confirmToggleState(this.getAttribute('data-caisse-id'), this.getAttribute('data-caisse-name'), this.getAttribute('data-action'))"
                                                title="Désactiver" class="text-yellow-600 hover:text-yellow-900 bg-yellow-50 hover:bg-yellow-100 p-3 rounded-lg transition duration-200"><i class="fas fa-times-circle"></i></button>
                                    </form>

                                    <button th:attr="data-caisse-id=${caisse.id}, data-caisse-name=${caisse.nom}" onclick="confirmDelete(this.getAttribute('data-caisse-id'), this.getAttribute('data-caisse-name'))" title="Supprimer" class="text-red-600 hover:text-red-900 bg-red-50 hover:bg-red-100 p-3 rounded-lg transition duration-200"><i class="fas fa-trash"></i></button>
                                    <form th:id="|deleteForm-${caisse.id}|" th:action="@{/gestion-caisses/delete/{id}(id=${caisse.id})}" method="post" style="display: none;">
                                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                                    </form>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Sessions Ouvertes Tab -->
        <div class="hidden p-4 rounded-lg bg-gray-50" id="open-sessions" role="tabpanel" aria-labelledby="open-sessions-tab">
            <h3 class="text-xl font-bold text-gray-900 mb-4">Sessions de Caisse Ouvertes</h3>

            <form th:action="@{/gestion-caisses}" method="get" class="mb-6">
                <input type="hidden" name="tab" value="open-sessions">
                <div class="flex items-center">
                    <input type="search" name="openKeyword" th:value="${openKeyword}" placeholder="Rechercher par caissier..." class="form-input pl-10 pr-4 py-2 border rounded-lg w-full md:w-1/3">
                    <button type="submit" class="ml-2 px-4 py-2 bg-gray-800 text-white rounded-lg hover:bg-gray-900">Rechercher</button>
                </div>
            </form>

            <div th:if="${openSessionsPage.empty}" class="text-center py-16 bg-white rounded-lg shadow-md">
                <i class="fas fa-folder-open text-5xl text-gray-400 mb-4"></i>
                <p class="text-gray-600 text-lg">Aucune session ouverte actuellement.</p>
            </div>

            <div th:unless="${openSessionsPage.empty}" class="bg-white shadow-md rounded-2xl overflow-hidden">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"><i class="fas fa-user mr-2"></i>Ouvert par</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"><i class="fas fa-money-bill-wave mr-2"></i>Montant Initial</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"><i class="fas fa-calendar-alt mr-2"></i>Date Ouverture</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider"><i class="fas fa-cogs mr-2"></i>Actions</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        <tr th:each="caisseSession : ${openSessionsPage.content}">
                            <td class="px-6 py-4 whitespace-nowrap" th:text="${caisseSession.utilisateur.username}"></td>
                            <td class="px-6 py-4 whitespace-nowrap" th:text="${#numbers.formatDecimal(caisseSession.montantInitial, 1, 'POINT', 2, 'COMMA')} + ' FCFA'"></td>
                            <td class="px-6 py-4 whitespace-nowrap" th:text="${#temporals.format(caisseSession.dateOuverture, 'dd/MM/yyyy HH:mm')}"></td>
                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                <a th:href="@{/gestion-caisses/session-details/{id}(id=${caisseSession.id})}" class="text-blue-600 hover:text-blue-900">Détails</a>
                            </td>
                        </tr>
                    </tbody>
                </table>
                <div th:replace="~{fragments/pagination :: pagination(page=${openSessionsPage}, pageParamName='openPage', baseUrl=@{/gestion-caisses(tab='open-sessions', openKeyword=${openKeyword}, closedKeyword=${closedKeyword}, closedPage=${closedSessionsPage.number}, closedSize=${closedSessionsPage.size})})}"></div>
            </div>
        </div>

        <!-- Sessions Fermées Tab -->
        <div class="hidden p-4 rounded-lg bg-gray-50" id="closed-sessions" role="tabpanel" aria-labelledby="closed-sessions-tab">
            <h3 class="text-xl font-bold text-gray-900 mb-4">Historique des Sessions Fermées</h3>

            <form th:action="@{/gestion-caisses}" method="get" class="mb-6 bg-white p-6 rounded-xl shadow-lg border border-gray-100">
                <input type="hidden" name="tab" value="closed-sessions">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 items-end">

                    <div class="lg:col-span-2">
                        <label for="closedKeyword" class="block text-sm font-medium text-gray-800 mb-1">Caissier</label>
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i class="fas fa-user text-gray-400"></i>
                            </div>
                            <input type="search" id="closedKeyword" name="closedKeyword" th:value="${closedKeyword}" placeholder="Nom du caissier..." class="block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        </div>
                    </div>

                    <div>
                        <label for="startDate" class="block text-sm font-medium text-gray-800 mb-1">Date de début</label>
                        <div class="relative">
                             <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i class="fas fa-calendar-alt text-gray-400"></i>
                            </div>
                            <input type="date" id="startDate" name="startDate" th:value="${startDate}" class="block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        </div>
                    </div>

                    <div>
                        <label for="endDate" class="block text-sm font-medium text-gray-800 mb-1">Date de fin</label>
                        <div class="relative">
                             <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i class="fas fa-calendar-alt text-gray-400"></i>
                            </div>
                            <input type="date" id="endDate" name="endDate" th:value="${endDate}" class="block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        </div>
                    </div>

                    <div class="flex items-end">
                        <button type="submit" class="w-full bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 flex items-center justify-center shadow-md hover:shadow-lg transition-transform transform hover:-translate-y-0.5">
                            <i class="fas fa-filter mr-2"></i>
                            <span>Filtrer</span>
                        </button>
                    </div>
                </div>
            </form>

            <div th:if="${closedSessionsPage.empty}" class="text-center py-16 bg-white rounded-lg shadow-md">
                <i class="fas fa-history text-5xl text-gray-400 mb-4"></i>
                <p class="text-gray-600 text-lg">Aucune session fermée trouvée pour les critères sélectionnés.</p>
            </div>

            <div th:unless="${closedSessionsPage.empty}" class="bg-white shadow-md rounded-2xl overflow-hidden">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"><i class="fas fa-user mr-2"></i>Caissier</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"><i class="fas fa-money-bill-wave mr-2"></i>Montant Initial</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"><i class="fas fa-money-check-alt mr-2"></i>Montant Final</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"><i class="fas fa-calendar-alt mr-2"></i>Date Ouverture</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"><i class="fas fa-calendar-times mr-2"></i>Date Fermeture</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"><i class="fas fa-balance-scale-left mr-2"></i>Écart</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider"><i class="fas fa-cogs mr-2"></i>Actions</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        <tr th:each="caisseSession : ${closedSessionsPage.content}">
                            <td class="px-6 py-4 whitespace-nowrap" th:text="${caisseSession.utilisateur.username}"></td>
                            <td class="px-6 py-4 whitespace-nowrap" th:text="${#numbers.formatDecimal(caisseSession.montantInitial, 1, 'POINT', 2, 'COMMA')} + ' FCFA'"></td>
                            <td class="px-6 py-4 whitespace-nowrap" th:text="${#numbers.formatDecimal(caisseSession.montantFinal, 1, 'POINT', 2, 'COMMA')} + ' FCFA'"></td>
                            <td class="px-6 py-4 whitespace-nowrap" th:text="${#temporals.format(caisseSession.dateOuverture, 'dd/MM/yyyy HH:mm')}"></td>
                            <td class="px-6 py-4 whitespace-nowrap" th:text="${#temporals.format(caisseSession.dateFermeture, 'dd/MM/yyyy HH:mm')}"></td>
                            <td class="px-6 py-4 whitespace-nowrap font-bold"
                                th:text="${#numbers.formatDecimal(caisseSession.ecart, 1, 'POINT', 2, 'COMMA')} + ' FCFA'"
                                th:classappend="${caisseSession.ecart < 0 ? 'text-red-600' : 'text-green-600'}">
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                <a th:href="@{/gestion-caisses/session-details/{id}(id=${caisseSession.id})}" class="text-blue-600 hover:text-blue-900">Historique</a>
                            </td>
                        </tr>
                    </tbody>
                </table>
                <div th:replace="~{fragments/pagination :: pagination(page=${closedSessionsPage}, pageParamName='closedPage', baseUrl=@{/gestion-caisses(tab='closed-sessions', openKeyword=${openKeyword}, openPage=${openSessionsPage.number}, openSize=${openSessionsPage.size}, openSortField=${openSortField}, openSortDir=${openSortDir}, closedKeyword=${closedKeyword}, closedSize=${closedSessionsPage.size}, closedSortField=${closedSortField}, closedSortDir=${closedSortDir})})}"></div>
            </div>
        </div>
    </div>
</div>

<script th:inline="javascript">
    /*<![CDATA[*/
    const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
    const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

    async function openCaisseModal(caisseId) {
        const url = caisseId ? `/gestion-caisses/form?id=${caisseId}` : '/gestion-caisses/form';
        try {
            const response = await fetch(url);
            if (!response.ok) throw new Error('Could not load the form.');
            const formHtml = await response.text();

            Swal.fire({
                html: formHtml,
                width: '800px',
                showCancelButton: true,
                showConfirmButton: true,
                confirmButtonText: '<i class="fas fa-save mr-2"></i>Sauvegarder',
                cancelButtonText: '<i class="fas fa-times mr-2"></i>Annuler',
                confirmButtonColor: '#2563eb',
                cancelButtonColor: '#6b7280',
                showLoaderOnConfirm: true,
                preConfirm: () => {
                    const form = document.getElementById('caisse-form');
                    if (!form.checkValidity()) {
                        form.reportValidity();
                        return false;
                    }
                    const formData = new FormData(form);
                    return fetch('/gestion-caisses/save', {
                        method: 'POST',
                        headers: { [csrfHeader]: csrfToken },
                        body: formData
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (!data.success) throw new Error(data.message);
                        return data;
                    })
                    .catch(error => {
                        Swal.showValidationMessage(`La requête a échoué: ${error}`);
                    });
                },
                allowOutsideClick: () => !Swal.isLoading()
            }).then((result) => {
                if (result.isConfirmed) {
                    Swal.fire({
                        title: 'Succès!',
                        text: result.value.message,
                        icon: 'success',
                        timer: 2000,
                        showConfirmButton: false
                    }).then(() => location.reload());
                }
            });
        } catch (error) {
            Swal.fire('Erreur', 'Impossible de charger le formulaire.', 'error');
        }
    }

    function confirmDelete(caisseId, caisseName) {
        Swal.fire({
            title: 'Êtes-vous sûr ?',
            html: `<p>Vous êtes sur le point de supprimer la caisse : <strong>${caisseName}</strong></p><p>Cette action est irréversible.</p>`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#6b7280',
            confirmButtonText: 'Oui, supprimer !',
            cancelButtonText: 'Annuler'
        }).then((result) => {
            if (result.isConfirmed) {
                document.getElementById(`deleteForm-${caisseId}`).submit();
            }
        });
    }

    function confirmToggleState(caisseId, caisseName, action) {
        const isActivating = action === 'activate';
        const title = isActivating ? 'Activer la caisse' : 'Désactiver la caisse';
        const html = `Êtes-vous sûr de vouloir ${isActivating ? 'activer' : 'désactiver'} la caisse <strong>${caisseName}</strong> ?`;
        const confirmButtonText = isActivating ? 'Oui, activer' : 'Oui, désactiver';
        const confirmButtonColor = isActivating ? '#16a34a' : '#f59e0b';

        Swal.fire({
            title: title,
            html: html,
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: confirmButtonColor,
            cancelButtonColor: '#6b7280',
            confirmButtonText: confirmButtonText,
            cancelButtonText: 'Annuler'
        }).then((result) => {
            if (result.isConfirmed) {
                const formId = isActivating ? `activateForm-${caisseId}` : `deactivateForm-${caisseId}`;
                document.getElementById(formId).submit();
            }
        });
    }

    document.addEventListener('DOMContentLoaded', function() {
        var successMessage = /*[[${successMessage}]]*/ null;
        var errorMessage = /*[[${errorMessage}]]*/ null;

        if (successMessage) {
            Swal.fire({ title: 'Succès !', text: successMessage, icon: 'success', timer: 2500, showConfirmButton: false });
        }
        if (errorMessage) {
            Swal.fire({ title: 'Erreur !', text: errorMessage, icon: 'error' });
        }
    });
    /*]]>*/
</script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const tabs = document.querySelectorAll('#myTab button');
        const tabContents = document.querySelectorAll('#myTabContent > div');

        function activateTab(tab) {
            const target = document.querySelector(tab.dataset.tabsTarget);
            tabs.forEach(t => {
                t.classList.remove('border-blue-600', 'text-blue-600');
                t.setAttribute('aria-selected', 'false');
            });
            tabContents.forEach(tc => tc.classList.add('hidden'));

            tab.classList.add('border-blue-600', 'text-blue-600');
            tab.setAttribute('aria-selected', 'true');
            if(target) target.classList.remove('hidden');
        }

        tabs.forEach(tab => {
            tab.addEventListener('click', (event) => {
                const targetId = event.currentTarget.dataset.tabsTarget;
                history.pushState(null, null, `${window.location.pathname}${targetId}`);
                activateTab(event.currentTarget);
            });
        });

        // Activate tab based on URL hash or query param
        const urlParams = new URLSearchParams(window.location.search);
        const tabParam = urlParams.get('tab');
        let hash = window.location.hash;
        if (!hash && tabParam) {
            hash = '#' + tabParam;
        }

        if (hash) {
            const tabToActivate = document.querySelector(`button[data-tabs-target='${hash}']`);
            if (tabToActivate) {
                activateTab(tabToActivate);
            } else if (tabs.length > 0) {
                activateTab(tabs[0]);
            }
        } else if (tabs.length > 0) {
            activateTab(tabs[0]);
        }
    });
</script>

</body>
</html>