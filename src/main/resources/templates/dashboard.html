<!DOCTYPE html>
<html lang="fr" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body class="bg-gray-50">

<!-- Header -->
<div th:replace="~{fragments/tailwind-header :: tailwind-header(pageTitle='Tableau de Bord Admin')}"></div>

<div class="w-full px-4 sm:px-6 lg:px-8 py-8">

    <!-- Message de bienvenue -->
    <div class="mb-8">
        <h2 class="text-3xl font-bold text-gray-800">Bonjour, <span sec:authentication="name"></span> !</h2>
        <p class="text-gray-600">Voici un aperçu de votre boutique aujourd'hui.</p>
    </div>

    <!-- Accès Rapide -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 mb-8">
        <h3 class="text-xl font-semibold text-gray-800 mb-4">Accès Rapide</h3>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <a th:href="@{/produits}" class="bg-gray-50 rounded-lg p-4 hover:bg-gray-100 transition-colors duration-200 flex items-center space-x-4">
                <div class="bg-green-100 p-3 rounded-lg"><i class="fas fa-list text-green-600"></i></div>
                <div>
                    <p class="font-semibold text-gray-800">Liste des Produits</p>
                    <p class="text-sm text-gray-500">Voir tous les articles</p>
                </div>
            </a>
            <a th:href="@{/rapports/stock-bas}" class="bg-gray-50 rounded-lg p-4 hover:bg-gray-100 transition-colors duration-200 flex items-center space-x-4">
                <div class="bg-red-100 p-3 rounded-lg"><i class="fas fa-box-open text-red-600"></i></div>
                <div>
                    <p class="font-semibold text-gray-800">Stock Bas</p>
                    <p class="text-sm text-gray-500">Produits critiques</p>
                </div>
            </a>
            <a th:href="@{/rapports/ventes-historique}" class="bg-gray-50 rounded-lg p-4 hover:bg-gray-100 transition-colors duration-200 flex items-center space-x-4">
                <div class="bg-blue-100 p-3 rounded-lg"><i class="fas fa-history text-blue-600"></i></div>
                <div>
                    <p class="font-semibold text-gray-800">Historique Ventes</p>
                    <p class="text-sm text-gray-500">Consulter les ventes</p>
                </div>
            </a>
            <a th:href="@{/utilisateurs}" class="bg-gray-50 rounded-lg p-4 hover:bg-gray-100 transition-colors duration-200 flex items-center space-x-4">
                <div class="bg-indigo-100 p-3 rounded-lg"><i class="fas fa-users-cog text-indigo-600"></i></div>
                <div>
                    <p class="font-semibold text-gray-800">Gérer Utilisateurs</p>
                    <p class="text-sm text-gray-500">Administrer les accès</p>
                </div>
            </a>
        </div>
    </div>

    <!-- Cartes Statistiques -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 mb-8">
        <h3 class="text-xl font-semibold text-gray-800 mb-4">Statistiques Clés</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
            <!-- Carte Total Produits -->
            <div class="bg-gray-50 rounded-lg p-4">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Total Produits</p>
                        <p class="text-2xl font-bold text-gray-900 mt-2" th:text="${totalProduits}">0</p>
                    </div>
                    <div class="bg-blue-100 p-3 rounded-lg"><i class="fas fa-boxes text-blue-600 text-xl"></i></div>
                </div>
            </div>
            <!-- Carte Stock Bas -->
            <div class="bg-gray-50 rounded-lg p-4">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Stock Bas</p>
                        <p class="text-2xl font-bold text-orange-500 mt-2" th:text="${produitsStockBas}">0</p>
                    </div>
                    <div class="bg-orange-100 p-3 rounded-lg"><i class="fas fa-exclamation-triangle text-orange-500 text-xl"></i></div>
                </div>
            </div>
            <!-- Carte Total Personnel -->
            <div class="bg-gray-50 rounded-lg p-4">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Total Personnel</p>
                        <p class="text-2xl font-bold text-gray-900 mt-2" th:text="${totalPersonnel}">0</p>
                    </div>
                    <div class="bg-green-100 p-3 rounded-lg"><i class="fas fa-users text-green-600 text-xl"></i></div>
                </div>
            </div>
            <!-- Carte Total Utilisateurs -->
            <div class="bg-gray-50 rounded-lg p-4">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Total Utilisateurs</p>
                        <p class="text-2xl font-bold text-gray-900 mt-2" th:text="${totalUtilisateurs}">0</p>
                    </div>
                    <div class="bg-indigo-100 p-3 rounded-lg"><i class="fas fa-user-shield text-indigo-600 text-xl"></i></div>
                </div>
            </div>
            <!-- Carte Valeur du Stock -->
            <div class="bg-gray-50 rounded-lg p-4">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Valeur du Stock</p>
                        <p class="text-2xl font-bold text-gray-900 mt-2" th:text="${#numbers.formatDecimal(valeurStock, 0, 'POINT', 0, 'COMMA')} + ' FCFA'">0 FCFA</p>
                    </div>
                    <div class="bg-purple-100 p-3 rounded-lg"><i class="fas fa-dollar-sign text-purple-600 text-xl"></i></div>
                </div>
            </div>
            <!-- Carte Ventes du Jour -->
            <div class="bg-gray-50 rounded-lg p-4">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Ventes du Jour</p>
                        <p class="text-2xl font-bold text-gray-900 mt-2" th:text="${nombreVentesAujourdhui}">0</p>
                    </div>
                    <div class="bg-cyan-100 p-3 rounded-lg"><i class="fas fa-shopping-cart text-cyan-600 text-xl"></i></div>
                </div>
            </div>
            <!-- Carte CA Aujourd'hui -->
            <div class="bg-gray-50 rounded-lg p-4">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">CA Aujourd'hui</p>
                        <p class="text-2xl font-bold text-green-600 mt-2" th:text="${#numbers.formatDecimal(chiffreAffairesAujourdhui, 0, 'POINT', 0, 'COMMA')} + ' FCFA'">0 FCFA</p>
                    </div>
                    <div class="bg-green-100 p-3 rounded-lg"><i class="fas fa-cash-register text-green-600 text-xl"></i></div>
                </div>
            </div>
            <!-- Carte CA du Mois -->
            <div class="bg-gray-50 rounded-lg p-4">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">CA du Mois</p>
                        <p class="text-2xl font-bold text-teal-600 mt-2" th:text="${#numbers.formatDecimal(chiffreAffairesMois, 0, 'POINT', 0, 'COMMA')} + ' FCFA'">0 FCFA</p>
                    </div>
                    <div class="bg-teal-100 p-3 rounded-lg"><i class="fas fa-calendar-alt text-teal-600 text-xl"></i></div>
                </div>
            </div>
        </div>
    </div>


    <!-- Section Principale: Graphiques et Activités -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mt-8">
        <!-- Graphique des Ventes -->
        <div class="lg:col-span-3 bg-white rounded-xl shadow-sm border border-gray-100 p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Ventes des 7 derniers jours</h3>
            <div>
                <canvas id="ventesChart"></canvas>
            </div>
        </div>

        <!-- Graphique d'activité -->
        <div class="lg:col-span-2 bg-white rounded-xl shadow-sm border border-gray-100 p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Activité des 7 derniers jours (Entrées/Sorties)</h3>
            <div>
                <canvas id="mouvementsChart"></canvas>
            </div>
        </div>

        <!-- Graphique des catégories -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Répartition par catégorie</h3>
            <div>
                <canvas id="categoryChart"></canvas>
            </div>
        </div>

        <!-- Graphique des ventes par catégorie -->
        <div class="lg:col-span-3 bg-white rounded-xl shadow-sm border border-gray-100 p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Ventes par catégorie</h3>
            <div>
                <canvas id="salesByCategoryChart"></canvas>
            </div>
        </div>

        <!-- Derniers Mouvements de Stock -->
        <div class="lg:col-span-2 bg-white rounded-xl shadow-sm border border-gray-100 p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Derniers Mouvements</h3>
            <div th:if="${#lists.isEmpty(derniersMouvements)}" class="text-center text-gray-500 py-4">Aucun mouvement récent.</div>
            <div th:unless="${#lists.isEmpty(derniersMouvements)}" class="space-y-4">
                <div th:each="mvt : ${derniersMouvements}" class="flex items-center text-sm">
                    <i class="fas fa-fw me-3" th:classappend="${mvt.typeMouvement.name() == 'ENTREE'} ? 'fa-arrow-down text-green-500' : 'fa-arrow-up text-red-500'"></i>
                    <div class="flex-grow">
                        <span th:text="${mvt.typeMouvement.libelle}" class="font-semibold"></span>
                        <span th:text="'(' + ${mvt.quantite} + ')'"></span>
                        <a th:href="@{/stock/history/{id}(id=${mvt.produit.id})}" class="font-semibold text-blue-600 hover:underline" th:text="${mvt.produit.nom}"></a>
                    </div>
                    <div class="text-xs text-gray-500" th:text="${#temporals.format(mvt.dateMouvement, 'dd/MM')}"></div>
                </div>
            </div>
        </div>

        <!-- Top 5 Produits Vendus -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Top 5 Produits Vendus</h3>
            <div th:if="${#lists.isEmpty(topProduits)}" class="text-center text-gray-500 py-4">Aucune vente enregistrée.</div>
            <div th:unless="${#lists.isEmpty(topProduits)}" class="space-y-3">
                <div th:each="top, iterStat : ${topProduits}" class="flex items-center text-sm">
                    <div class="w-6 text-center me-3 text-gray-500 font-bold" th:text="${iterStat.count} + '.'"></div>
                    <div class="flex-grow">
                        <a th:href="@{/stock/history/{id}(id=${top.produit.id})}" class="font-semibold text-blue-600 hover:underline" th:text="${top.produit.nom}"></a>
                    </div>
                    <div class="text-xs font-bold bg-gray-100 text-gray-700 px-2 py-1 rounded-md" th:text="${top.totalVendu} + ' vendus'"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script th:inline="javascript">
    /*<![CDATA[*/
    document.addEventListener('DOMContentLoaded', function() {
        const chartLabels = /*[[${chartLabels}]]*/ [];
        const entreesData = /*[[${entreesData}]]*/ [];
        const sortiesData = /*[[${sortiesData}]]*/ [];

        const categoryLabels = /*[[${categoryLabels}]]*/ [];
        const categoryData = /*[[${categoryData}]]*/ [];

        const salesByCategoryLabels = /*[[${salesByCategoryLabels}]]*/ [];
        const salesByCategoryData = /*[[${salesByCategoryData}]]*/ [];

        const ctx = document.getElementById('mouvementsChart').getContext('2d');
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: chartLabels,
                datasets: [
                    {
                        label: 'Entrées',
                        data: entreesData,
                        backgroundColor: 'rgba(74, 222, 128, 0.6)', // green-400
                        borderColor: 'rgba(34, 197, 94, 1)',     // green-600
                        borderWidth: 1
                    },
                    {
                        label: 'Sorties',
                        data: sortiesData,
                        backgroundColor: 'rgba(248, 113, 113, 0.6)', // red-400
                        borderColor: 'rgba(239, 68, 68, 1)',      // red-600
                        borderWidth: 1
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        stacked: true,
                    },
                    y: {
                        stacked: true,
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1
                        }
                    }
                },
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                    }
                }
            }
        });

        const categoryCtx = document.getElementById('categoryChart').getContext('2d');
        new Chart(categoryCtx, {
            type: 'doughnut',
            data: {
                labels: categoryLabels,
                datasets: [{
                    label: 'Produits par catégorie',
                    data: categoryData,
                    backgroundColor: [
                        'rgba(59, 130, 246, 0.7)',
                        'rgba(249, 115, 22, 0.7)',
                        'rgba(22, 163, 74, 0.7)',
                        'rgba(239, 68, 68, 0.7)',
                        'rgba(139, 92, 246, 0.7)',
                    ],
                    borderColor: [
                        'rgba(59, 130, 246, 1)',
                        'rgba(249, 115, 22, 1)',
                        'rgba(22, 163, 74, 1)',
                        'rgba(239, 68, 68, 1)',
                        'rgba(139, 92, 246, 1)',
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                    }
                }
            }
        });

        const salesByCategoryCtx = document.getElementById('salesByCategoryChart').getContext('2d');
        new Chart(salesByCategoryCtx, {
            type: 'bar',
            data: {
                labels: salesByCategoryLabels,
                datasets: [{
                    label: 'Ventes par catégorie',
                    data: salesByCategoryData,
                    backgroundColor: 'rgba(236, 72, 153, 0.6)',
                    borderColor: 'rgba(236, 72, 153, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });

        // Fetch and render Sales Chart
        fetch('/dashboard/api/ventes-par-jour?jours=7')
            .then(response => response.json())
            .then(salesData => {
                const ventesCtx = document.getElementById('ventesChart').getContext('2d');
                new Chart(ventesCtx, {
                    type: 'line',
                    data: {
                        labels: salesData.labels,
                        datasets: [{
                            label: 'Chiffre d\'affaires (FCFA)',
                            data: salesData.data,
                            backgroundColor: 'rgba(59, 130, 246, 0.2)',
                            borderColor: 'rgba(59, 130, 246, 1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value, index, values) {
                                        return new Intl.NumberFormat('fr-FR').format(value) + ' FCFA';
                                    }
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let label = context.dataset.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        if (context.parsed.y !== null) {
                                            label += new Intl.NumberFormat('fr-FR').format(context.parsed.y) + ' FCFA';
                                        }
                                        return label;
                                    }
                                }
                            }
                        }
                    }
                });
            });
    });
    /*]]>*/
</script>

</body>
</html>