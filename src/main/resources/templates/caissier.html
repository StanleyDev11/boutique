<!DOCTYPE html>
<html lang="fr" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Caissier Pro - Interface Caissier</title>
  <meta name="_csrf" th:content="${_csrf.token}"/>
  <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.jsdelivr.net/npm/vanta@latest/dist/vanta.waves.min.js"></script>
</head>
<body class="bg-gray-50">

<!-- Header with Vanta.js background -->
<header id="vanta-header" class="relative h-16 shadow-md">
    <div class="absolute inset-0 bg-gray-800"></div> <!-- Changed color here -->
    <div class="relative container mx-auto h-full flex items-center justify-between px-4">
        <div class="flex items-center"> <!-- Added a div for logo and title -->
            <img th:src="@{/lo.png}" alt="Logo" class="h-10 w-auto mr-4"> <!-- Added logo here -->
            <h1 class="text-2xl font-bold text-white">
                <i class="fas fa-cash-register mr-2"></i> Caissier Pro
            </h1>
        </div>
        <div class="flex items-center space-x-4">
            <div id="connection-status" class="flex items-center space-x-2">
                <span class="h-3 w-3 bg-green-500 rounded-full animate-pulse"></span>
                <span class="text-white text-sm font-medium">En ligne</span>
            </div>
            <div id="clock" class="text-white text-sm font-mono text-center"></div>
            <span class="text-white hidden md:inline">Session: <span class="font-bold" sec:authentication="name"></span></span>
            <a th:href="@{/dashboard}" sec:authorize="hasRole('ADMIN')" class="bg-white/10 hover:bg-white/20 text-white px-4 py-1 rounded-full transition" title="Dashboard">
                <i class="fas fa-tachometer-alt"></i>
            </a>
            <form id="logout-form" th:action="@{/logout}" method="post" class="inline">
                <button type="submit" class="bg-white/10 hover:bg-white/20 text-white px-4 py-1 rounded-full transition" title="Déconnexion">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </form>
        </div>
    </div>
</header>

<div class="flex flex-col md:flex-row h-[calc(100vh-4rem)]">
  <!-- Left Sidebar - Product Navigation -->
  <aside class="w-full md:w-[40rem] bg-white shadow-md p-4 overflow-y-auto">
    <div class="mb-8">
      <h2 class="text-lg font-bold mb-2 text-indigo-800 flex items-center">
        <i class="fas fa-filter mr-2"></i> Filtres
      </h2>
      <input type="text" id="search-input" placeholder="Recherche..."
             class="w-full px-3 py-2 border border-gray-200 rounded-lg mb-3 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
      <select id="category-filter" class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-indigo-500">
        <option value="">Toutes catégories</option>
        <option th:each="category : ${categories}" th:value="${category}" th:text="${category}"></option>
      </select>
    </div>

    <div class="mb-4">
      <h2 class="text-lg font-bold mb-2 text-indigo-800 flex items-center">
        <i class="fas fa-tags mr-2"></i> Produits
      </h2>
      <div id="product-list" class="space-y-2">
        <div th:each="produit : ${produits}"
             class="product-card p-3 rounded-lg hover:bg-indigo-50 cursor-pointer transition border border-gray-100"
             th:data-id="${produit.id}" th:data-nom="${produit.nom}"
             th:data-prix="${produit.prixVenteUnitaire}"
             th:data-categorie="${produit.categorie}"
             th:data-codebarres="${produit.codeBarres}"
             th:data-stock="${produit.quantiteEnStock}">
          <div class="flex justify-between items-start">
            <h3 class="font-semibold" th:text="${produit.nom}"></h3>
            <span class="text-xs px-2 py-1 rounded-full"
                  th:classappend="${produit.quantiteEnStock <= 5 ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'}">
                            <span th:text="${produit.quantiteEnStock}"></span> en stock
                        </span>
          </div>
          <p class="text-lg font-bold text-indigo-600" th:text="${produit.prixVenteUnitaire} + ' FCFA'"></p>
        </div>
      </div>
    </div>
  </aside>

  <!-- Main Content Area -->
  <main class="flex-1 flex flex-col overflow-hidden">
    <!-- Tabs Navigation -->
    <div class="bg-indigo-50 px-4 py-2 flex items-center overflow-x-auto">
      <div id="tabs-container" class="flex space-x-2"></div>
      <button id="new-tab-btn" class="ml-2 p-1 rounded-full bg-indigo-600 text-white hover:bg-indigo-700">
        <i class="fas fa-plus text-xs"></i>
      </button>
    </div>

    <!-- Main Content -->
    <div class="flex-1 grid grid-cols-1 lg:grid-cols-2 gap-4 p-4 overflow-hidden">
      <!-- Product Details Panel -->
      <div id="sale-details" class="bg-white rounded-xl shadow-sm p-4 hidden">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-xl font-bold text-indigo-800">Détails Produit</h3>
          <button id="close-details" class="text-gray-400 hover:text-gray-600">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div id="product-details-content" class="space-y-4"></div>
      </div>

      <!-- Cart Panel -->
      <div class="bg-white rounded-xl shadow-sm p-4 flex flex-col h-full">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-xl font-bold text-indigo-800">
            <i class="fas fa-shopping-cart mr-2"></i> Panier
          </h3>
          <div>
            <button id="clear-cart-button" class="text-red-500 hover:text-red-700 mr-3">
              <i class="fas fa-trash mr-1"></i> Vider
            </button>
            <button id="discount-btn" class="text-indigo-600 hover:text-indigo-800">
              <i class="fas fa-percentage mr-1"></i> Remise
            </button>
          </div>
        </div>

        <!-- Client Info -->
        <div id="selected-client-display" class="hidden bg-indigo-50 p-3 rounded-lg mb-4">
          <div class="flex justify-between items-center">
            <div>
              <p class="text-xs text-indigo-500">Client</p>
              <p class="font-bold" id="selected-client-name"></p>
            </div>
            <button id="remove-client-btn" class="text-red-500 hover:text-red-700">
              <i class="fas fa-times"></i>
            </button>
          </div>
        </div>
        <div id="client-search-section" class="mb-4">
          <div class="relative">
            <input type="text" id="client-search-input" placeholder="Rechercher un client..."
                   class="w-full px-4 py-2 border border-gray-200 rounded-lg pl-10 focus:ring-2 focus:ring-indigo-500">
            <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
            <button id="add-client-btn" class="absolute right-2 top-2 bg-indigo-600 text-white p-1 rounded-lg hover:bg-indigo-700">
              <i class="fas fa-plus text-xs"></i>
            </button>
          </div>
          <div id="client-search-results" class="mt-1 border border-gray-100 rounded-lg max-h-40 overflow-y-auto hidden"></div>
        </div>

        <!-- Cart Items -->
        <div id="cart-items" class="flex-grow overflow-y-auto space-y-3 mb-4"></div>

        <!-- Totals -->
        <div id="total-section" class="border-t pt-4 space-y-2">
          <div class="flex justify-between">
            <span>Sous-total:</span>
            <span id="subtotal-amount">0.00 FCFA</span>
          </div>
          <div class="flex justify-between">
            <span>Remise:</span>
            <span id="discount-amount" class="text-red-500">-0.00 FCFA</span>
          </div>
          <div class="flex justify-between text-lg font-bold pt-2 border-t">
            <span>Total:</span>
            <span id="final-total" class="text-indigo-600">0.00 FCFA</span>
          </div>
        </div>

        <!-- Payment Button -->
        <button id="pay-button" class="w-full bg-gradient-to-r from-indigo-600 to-indigo-800 hover:from-indigo-700 hover:to-indigo-900 text-white py-3 rounded-lg font-bold mt-4 shadow-md transition-all hover:shadow-lg">
          <i class="fas fa-credit-card mr-2"></i> Payer
        </button>
      </div>
    </div>
  </main>
</div>

<!-- Scripts -->
<script th:inline="javascript">
    /*<![CDATA[*/
    const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
    const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');
    const initialClients = /*[[${clients}]]*/ [];

    document.addEventListener('DOMContentLoaded', function() {
        // --- DOM Elements ---
        const searchInput = document.getElementById('search-input');
        const categoryFilter = document.getElementById('category-filter');
        const productList = document.getElementById('product-list');
        const saleDetails = document.getElementById('sale-details');
        const productDetailsContent = document.getElementById('product-details-content');
        const closeDetailsBtn = document.getElementById('close-details');
        const cartItemsContainer = document.getElementById('cart-items');
        const totalSection = document.getElementById('total-section');
        const subtotalAmount = document.getElementById('subtotal-amount');
        const discountAmount = document.getElementById('discount-amount');
        const finalTotal = document.getElementById('final-total');
        const payButton = document.getElementById('pay-button');
        const clearCartButton = document.getElementById('clear-cart-button');
        const discountBtn = document.getElementById('discount-btn');
        const tabsContainer = document.getElementById('tabs-container');
        const newTabBtn = document.getElementById('new-tab-btn');
        const clientSearchInput = document.getElementById('client-search-input');
        const clientSearchResults = document.getElementById('client-search-results');
        const addClientBtn = document.getElementById('add-client-btn');
        const selectedClientDisplay = document.getElementById('selected-client-display');
        const selectedClientName = document.getElementById('selected-client-name');
        const removeClientBtn = document.getElementById('remove-client-btn');
        const clientSearchSection = document.getElementById('client-search-section');

        // --- State ---
        let tabs = [{ id: 1, cart: [], selectedClient: null, discountAmount: 0 }];
        let activeTabIndex = 0;
        let nextTabId = 2;

        // --- Initialization ---
        searchInput.focus();
        renderTabs();
        switchTab(0);

        const Toast = Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 2000, timerProgressBar: true });

        // --- Tab Management ---
        function renderTabs() {
            tabsContainer.innerHTML = '';
            tabs.forEach((tab, index) => {
                const tabButton = document.createElement('button');
                tabButton.className = `px-4 py-2 rounded-md text-sm font-medium ` + (index === activeTabIndex ? 'bg-indigo-600 text-white shadow' : 'bg-white text-gray-600 hover:bg-indigo-100');
                let content = `Tab ${tab.id}`;
                if (tab.cart.length > 0) content += ` <span class="bg-white text-indigo-600 text-xs rounded-full px-1.5 py-0.5 ml-1">${tab.cart.length}</span>`;
                if (tab.selectedClient) content += ` <i class="fas fa-user ml-2 text-xs"></i>`;
                tabButton.innerHTML = content;
                tabButton.addEventListener('click', () => switchTab(index));
                tabsContainer.appendChild(tabButton);
            });
        }
        
        function addNewTab() {
            tabs.push({ id: nextTabId++, cart: [], selectedClient: null, discountAmount: 0 });
            switchTab(tabs.length - 1);
        }

        function switchTab(index) {
            activeTabIndex = index;
            renderTabs();
            renderActiveTabContent();
        }

        function filterProducts() {
            const searchTerm = searchInput.value.toLowerCase();
            const selectedCategory = categoryFilter.value;
            document.querySelectorAll('.product-card').forEach(card => {
                const isVisible = (card.dataset.nom.toLowerCase().includes(searchTerm) || (card.dataset.codebarres || '').toLowerCase().includes(searchTerm)) &&
                                  (!selectedCategory || card.dataset.categorie === selectedCategory);
                card.style.display = isVisible ? 'block' : 'none';
            });
        }

        // --- Product & Cart Logic ---
        productList.addEventListener('click', function(e) {
            const card = e.target.closest('.product-card');
            if (!card) return;

            const productId = card.dataset.id;
            const stock = parseInt(card.dataset.stock);
            const itemInCart = tabs[activeTabIndex].cart.find(item => item.id === productId);
            const qtyInCart = itemInCart ? itemInCart.quantity : 0;

            if (stock - qtyInCart <= 0) {
                Swal.fire('Stock épuisé', `Il ne reste plus de ${card.dataset.nom} en stock.`, 'warning');
                return;
            }
            displaySaleDetails(card.dataset);
        });

        function displaySaleDetails(productData) {
            const { id, nom, prix, stock } = productData;
            const itemInCart = tabs[activeTabIndex].cart.find(item => item.id === id);
            const qtyInCart = itemInCart ? itemInCart.quantity : 0;
            const availableStock = stock - qtyInCart;

            productDetailsContent.innerHTML = `
                <h3 class="font-bold text-lg">${nom}</h3>
                <p>Prix: ${parseFloat(prix).toFixed(2)} FCFA / <span class="text-sm text-gray-600">Stock dispo: ${availableStock}</span></p>
                <div class="mt-4">
                    <label for="quantity" class="block text-sm font-medium text-gray-700">Quantité</label>
                    <input type="number" id="quantity" value="1" min="1" max="${availableStock}" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                </div>
                <div class="mt-4"><p class="font-bold">Total: <span id="total-price">${parseFloat(prix).toFixed(2)}</span> FCFA</p></div>
                <button id="add-to-cart" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg mt-4"><i class="fas fa-cart-plus"></i> Ajouter</button>
            `;
            saleDetails.classList.remove('hidden');

            const qtyInput = document.getElementById('quantity');
            qtyInput.addEventListener('input', () => {
                document.getElementById('total-price').textContent = (qtyInput.value * parseFloat(prix)).toFixed(2);
            });
            document.getElementById('add-to-cart').addEventListener('click', () => {
                addToCart(id, nom, parseFloat(prix), parseInt(qtyInput.value), parseInt(stock));
                saleDetails.classList.add('hidden');
            });
        }
        
        closeDetailsBtn.addEventListener('click', () => {
            saleDetails.classList.add('hidden');
        });

        function addToCart(productId, name, price, quantity, stock) {
            if (quantity <= 0) return;
            const tab = tabs[activeTabIndex];
            const itemInCart = tab.cart.find(item => item.id === productId);
            const qtyInCart = itemInCart ? itemInCart.quantity : 0;

            if (qtyInCart + quantity > stock) {
                Swal.fire('Quantité insuffisante', `Seulement ${stock - qtyInCart} restant(s) en stock.`, 'error');
                return;
            }

            if (itemInCart) {
                itemInCart.quantity += quantity;
            } else {
                tab.cart.push({ id: productId, name: name, price: price, quantity: quantity });
            }
            
            renderActiveTabContent();
            renderTabs();
            Toast.fire({ icon: 'success', title: `${name} ajouté` });
            searchInput.focus();
        }

        function updateCartItemQuantity(productId, change) {
            const tab = tabs[activeTabIndex];
            const item = tab.cart.find(i => i.id === productId);
            if (!item) return;

            const productCard = document.querySelector(`.product-card[data-id='${productId}']`);
            const stock = parseInt(productCard.dataset.stock);

            if (item.quantity + change > stock) {
                Toast.fire({ icon: 'error', title: 'Stock insuffisant' });
                return;
            }

            item.quantity += change;
            if (item.quantity <= 0) {
                tab.cart = tab.cart.filter(i => i.id !== productId);
            }
            renderActiveTabContent();
            renderTabs();
        }

        function clearCart() {
            const tab = tabs[activeTabIndex];
            if (tab.cart.length === 0) return;
            Swal.fire({ title: 'Vider le panier?', text: "Cette action est irréversible.", icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: 'Oui, vider!' })
                .then(result => {
                    if (result.isConfirmed) {
                        tab.cart = [];
                        tab.discountAmount = 0;
                        tab.selectedClient = null;
                        renderActiveTabContent();
                        renderTabs();
                        Toast.fire({ icon: 'success', title: 'Panier vidé' });
                    }
                });
        }

        // --- Client Management ---
        function renderClientSection() {
            const client = tabs[activeTabIndex].selectedClient;
            if (client) {
                selectedClientName.textContent = client.nom;
                selectedClientDisplay.classList.remove('hidden');
                clientSearchSection.classList.add('hidden');
            } else {
                selectedClientDisplay.classList.add('hidden');
                clientSearchSection.classList.remove('hidden');
                clientSearchInput.value = '';
            }
        }

        function selectClient(client) {
            tabs[activeTabIndex].selectedClient = client;
            clientSearchResults.innerHTML = '';
            clientSearchInput.value = '';
            clientSearchResults.classList.add('hidden');
            renderClientSection();
            renderTabs();
        }

        async function openAddClientModal() {
            const { value: formValues } = await Swal.fire({
                title: 'Ajouter un nouveau client',
                html: `
                    <input id="swal-input-name" class="swal2-input" placeholder="Nom du client">
                    <input id="swal-input-phone" class="swal2-input" placeholder="Téléphone (optionnel)">
                    <input id="swal-input-address" class="swal2-input" placeholder="Adresse (optionnel)">
                `,
                focusConfirm: false,
                showCancelButton: true,
                confirmButtonText: 'Ajouter',
                preConfirm: () => {
                    const nom = document.getElementById('swal-input-name').value;
                    if (!nom) {
                        Swal.showValidationMessage('Le nom est obligatoire');
                        return false;
                    }
                    return {
                        nom: nom,
                        telephone: document.getElementById('swal-input-phone').value,
                        adresse: document.getElementById('swal-input-address').value
                    }
                }
            });

            if (formValues) {
                try {
                    const response = await fetch('/api/clients', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', [csrfHeader]: csrfToken },
                        body: JSON.stringify(formValues)
                    });
                    if (response.ok) {
                        const newClient = await response.json();
                        selectClient(newClient);
                        Toast.fire({ icon: 'success', title: 'Client ajouté!' });
                    } else {
                        Swal.fire('Erreur', 'Ce client existe peut-être déjà.', 'error');
                    }
                } catch (error) {
                    console.error("Add client error:", error);
                    Swal.fire('Erreur', 'Impossible de contacter le serveur.', 'error');
                }
            }
        }

        // --- Discount Management ---
        async function openDiscountModal() {
            const { value: amount } = await Swal.fire({
                title: 'Appliquer une remise',
                input: 'number',
                inputLabel: 'Montant de la remise en FCFA',
                inputValue: tabs[activeTabIndex].discountAmount || 0,
                showCancelButton: true,
                inputValidator: (value) => {
                    if (value === '' || parseFloat(value) < 0) {
                        return 'Veuillez entrer un montant valide'
                    }
                }
            });

            if (amount) {
                tabs[activeTabIndex].discountAmount = parseFloat(amount);
                renderActiveTabContent();
            }
        }

        // --- Main Rendering & Payment ---
        function renderActiveTabContent() {
            const tab = tabs[activeTabIndex];
            cartItemsContainer.innerHTML = '';
            let subTotal = 0;

            tab.cart.forEach(item => {
                const itemTotal = item.price * item.quantity;
                subTotal += itemTotal;
                const cartItemEl = document.createElement('div');
                cartItemEl.className = 'flex justify-between items-center p-2 rounded-lg hover:bg-gray-50';
                cartItemEl.dataset.productId = item.id;
                cartItemEl.innerHTML = `
                    <div class="flex-grow">
                        <p class="font-semibold">${item.name}</p>
                        <div class="flex items-center text-sm text-gray-500 mt-1">
                            <button data-action="decrease" class="px-2 py-0.5 bg-gray-200 rounded-md hover:bg-gray-300"><i class="fas fa-minus"></i></button>
                            <p class="mx-3">${item.quantity}</p>
                            <button data-action="increase" class="px-2 py-0.5 bg-gray-200 rounded-md hover:bg-gray-300"><i class="fas fa-plus"></i></button>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="font-bold">${itemTotal.toFixed(2)} FCFA</p>
                        <button data-action="remove" class="text-red-400 hover:text-red-600 text-xs">Retirer</button>
                    </div>
                `;
                cartItemsContainer.appendChild(cartItemEl);
            });

            const discount = tab.discountAmount || 0;
            const finalTotalValue = subTotal - discount > 0 ? subTotal - discount : 0;

            subtotalAmount.textContent = `${subTotal.toFixed(2)} FCFA`;
            discountAmount.textContent = `-${discount.toFixed(2)} FCFA`;
            finalTotal.textContent = `${finalTotalValue.toFixed(2)} FCFA`;

            renderClientSection();
        }

        async function openPaymentModal() {
            const tab = tabs[activeTabIndex];
            if (tab.cart.length === 0) {
                Swal.fire({ icon: 'error', title: 'Oops...', text: 'Le panier est vide!' });
                return;
            }
            
            const subTotal = tab.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const finalTotalValue = subTotal - (tab.discountAmount || 0) > 0 ? subTotal - (tab.discountAmount || 0) : 0;

            const { value: formValues } = await Swal.fire({
                title: 'Finaliser la vente',
                html: `
                    <div class="text-left">
                        <p class="text-2xl font-bold text-center mb-4">Total à payer: ${finalTotalValue.toFixed(2)} FCFA</p>
                        <hr class="my-4">
                        <div class="mb-4">
                            <strong class="block mb-2">Type de vente:</strong>
                            <input type="radio" id="sale-direct" name="saleType" value="direct" checked><label for="sale-direct" class="swal2-radio-label">Payé</label>
                            <input type="radio" id="sale-credit" name="saleType" value="credit"><label for="sale-credit" class="swal2-radio-label">A crédit</label>
                        </div>
                        <div class="mb-4">
                            <strong class="block mb-2">Moyen de paiement:</strong>
                            <input type="radio" id="pay-cash" name="paymentMethod" value="cash" checked><label for="pay-cash" class="swal2-radio-label">Espèces</label>
                            <input type="radio" id="pay-card" name="paymentMethod" value="card"><label for="pay-card" class="swal2-radio-label">Carte</label>
                        </div>
                        <div id="tendered-amount-section" class="mb-4 text-center">
                            <label for="swal-input-tendered" class="block font-bold mb-2">Montant reçu:</label>
                            <input id="swal-input-tendered" class="swal2-input" type="number" placeholder="0.00" style="width: 12em;">
                        </div>
                        <div class="text-center bg-gray-100 p-3 rounded-md">
                            <strong class="block">Reliquat:</strong>
                            <span id="swal-change-display" class="text-2xl font-bold text-green-600">0.00 FCFA</span>
                        </div>
                    </div>
                `,
                focusConfirm: false,
                showCancelButton: true,
                confirmButtonText: 'Valider le paiement',
                cancelButtonText: 'Annuler',
                didOpen: () => {
                    const tenderedInput = document.getElementById('swal-input-tendered');
                    const changeDisplay = document.getElementById('swal-change-display');
                    const cashRadio = document.getElementById('pay-cash');
                    const cardRadio = document.getElementById('pay-card');
                    const creditRadio = document.getElementById('sale-credit');
                    const paymentMethodSection = cashRadio.closest('.mb-4');
                    const tenderedSection = document.getElementById('tendered-amount-section');

                    const updateTotal = () => {
                        const isCredit = creditRadio.checked;
                        const isCash = cashRadio.checked;
                        paymentMethodSection.style.display = isCredit ? 'none' : 'block';
                        tenderedSection.style.display = isCredit || !isCash ? 'none' : 'block';
                        const tendered = parseFloat(tenderedInput.value) || 0;
                        const change = tendered - finalTotalValue;
                        changeDisplay.textContent = (change > 0 ? change : 0).toFixed(2) + ' FCFA';
                    };

                    tenderedInput.addEventListener('input', updateTotal);
                    cashRadio.addEventListener('change', updateTotal);
                    cardRadio.addEventListener('change', updateTotal);
                    creditRadio.addEventListener('change', updateTotal);
                    document.getElementById('sale-direct').addEventListener('change', updateTotal);
                    updateTotal();
                },
                preConfirm: () => {
                    const saleType = document.querySelector('input[name="saleType"]:checked').value;
                    if (saleType === 'credit' && !tab.selectedClient) {
                        Swal.showValidationMessage('Veuillez sélectionner un client pour une vente à crédit.');
                        return false;
                    }
                    const paymentMethod = saleType === 'credit' ? 'credit' : document.querySelector('input[name="paymentMethod"]:checked').value;
                    const tenderedAmount = parseFloat(document.getElementById('swal-input-tendered').value) || 0;

                    if (saleType === 'direct' && paymentMethod === 'cash' && tenderedAmount < finalTotalValue) {
                        Swal.showValidationMessage('Le montant reçu est inférieur au total.');
                        return false;
                    }
                    return { saleType, paymentMethod, tenderedAmount };
                }
            });

            if (formValues) {
                fetch('/caissier/vendre', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', [csrfHeader]: csrfToken },
                    body: JSON.stringify({ 
                        cart: tab.cart,
                        saleType: formValues.saleType,
                        paymentMethod: formValues.paymentMethod,
                        clientId: tab.selectedClient ? tab.selectedClient.id : null,
                        discountAmount: tab.discountAmount
                    })
                })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        Swal.fire({
                            title: 'Vente enregistrée!',
                            text: data.message,
                            icon: 'success',
                            showCancelButton: true,
                            confirmButtonText: 'Imprimer le reçu',
                            cancelButtonText: 'Fermer'
                        }).then((result) => {
                            if (result.isConfirmed) {
                                printReceipt(tab, formValues, finalTotalValue);
                            }
                        });
                        tabs[activeTabIndex] = { id: tabs[activeTabIndex].id, cart: [], selectedClient: null, discountAmount: 0 }; // Reset tab
                        renderActiveTabContent();
                        renderTabs();
                    } else {
                        Swal.fire('Erreur!', data.message, 'error');
                    }
                })
                .catch(err => {
                    console.error('Sale error:', err);
                    Swal.fire('Erreur Connexion', 'La communication avec le serveur a échoué.', 'error');
                });
            }
        }

        function printReceipt(tab, saleData, finalTotal) {
            const now = new Date();
            const receiptWindow = window.open('', 'PRINT', 'height=600,width=400');
            const clientName = tab.selectedClient ? tab.selectedClient.nom : 'Client de passage';

            let receiptContent = `
                <html>
                <head>
                    <title>Reçu</title>
                    <style>
                        body { font-family: 'Courier New', monospace; font-size: 10pt; }
                        .container { width: 90%; margin: auto; }
                        h2 { text-align: center; }
                        hr { border-top: 1px dashed #000; }
                        .item { display: flex; justify-content: space-between; }
                        .total { text-align: right; font-weight: bold; margin-top: 10px; }
                        .footer { text-align: center; margin-top: 20px; }
                    </style>
                </head>
                <body>
                    <div class="container">
                        <h2>Votre Boutique</h2>
                        <p>Date: ${now.toLocaleDateString('fr-FR')} ${now.toLocaleTimeString('fr-FR')}</p>
                        <p>Client: ${clientName}</p>
                        <hr>
                        <div>
            `;

            tab.cart.forEach(item => {
                receiptContent += `
                    <div class="item">
                        <span>${item.name} (x${item.quantity})</span>
                        <span>${(item.price * item.quantity).toFixed(2)} FCFA</span>
                    </div>
                `;
            });

            receiptContent += `
                        </div>
                        <hr>
                        <div class="total">
                            <p>Sous-total: ${tab.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0).toFixed(2)} FCFA</p>
                            <p>Remise: -${(tab.discountAmount || 0).toFixed(2)} FCFA</p>
                            <p>Total: ${finalTotal.toFixed(2)} FCFA</p>
                        </div>
                        <div class="footer">
                            <p>Merci de votre visite !</p>
                        </div>
                    </div>
                </body>
                </html>
            `;

            receiptWindow.document.write(receiptContent);
            receiptWindow.document.close();
            receiptWindow.focus();
            receiptWindow.print();
            receiptWindow.close();
        }
        
        // --- Event Listeners ---
        cartItemsContainer.addEventListener('click', (e) => {
            const button = e.target.closest('button[data-action]');
            if (!button) return;
            const action = button.dataset.action;
            const cartItemEl = button.closest('[data-product-id]');
            const productId = cartItemEl.dataset.productId;

            if (action === 'increase') updateCartItemQuantity(productId, 1);
            if (action === 'decrease') updateCartItemQuantity(productId, -1);
            if (action === 'remove') {
                tabs[activeTabIndex].cart = tabs[activeTabIndex].cart.filter(i => i.id !== productId);
                renderActiveTabContent();
                renderTabs();
            }
        });
        clearCartButton.addEventListener('click', clearCart);
        discountBtn.addEventListener('click', openDiscountModal);
        searchInput.addEventListener('input', filterProducts);
        categoryFilter.addEventListener('change', filterProducts);
        payButton.addEventListener('click', openPaymentModal);
        newTabBtn.addEventListener('click', addNewTab);

        clientSearchInput.addEventListener('input', async (e) => {
            const query = e.target.value;
            if (query.length < 2) {
                clientSearchResults.innerHTML = '';
                clientSearchResults.classList.add('hidden');
                return;
            }
            try {
                const response = await fetch(`/api/clients/search?query=${query}`);
                const clients = await response.json();
                clientSearchResults.innerHTML = '';
                clients.forEach(client => {
                    const resultDiv = document.createElement('div');
                    resultDiv.className = 'p-2 cursor-pointer hover:bg-indigo-50';
                    resultDiv.textContent = client.nom;
                    resultDiv.addEventListener('click', () => selectClient(client));
                    clientSearchResults.appendChild(resultDiv);
                });
                clientSearchResults.classList.remove('hidden');
            } catch (error) {
                console.error('Client search error:', error);
            }
        });

        addClientBtn.addEventListener('click', openAddClientModal);

        removeClientBtn.addEventListener('click', () => {
            tabs[activeTabIndex].selectedClient = null;
            renderClientSection();
            renderTabs();
        });

        const logoutForm = document.getElementById('logout-form');
        if (logoutForm) {
            logoutForm.addEventListener('submit', function(event) {
                event.preventDefault(); // Prevent default form submission

                Swal.fire({
                    title: 'Déconnexion',
                    text: 'Êtes-vous sûr de vouloir vous déconnecter ?',
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: 'Oui, déconnecter',
                    cancelButtonText: 'Non, rester connecté',
                    reverseButtons: true
                }).then((result) => {
                    if (result.isConfirmed) {
                        logoutForm.submit(); // Submit the form if confirmed
                    }
                });
            });
        }
    });
    /*]]>*/
</script>

<script>
  // Initialize Vanta.js waves effect
  VANTA.WAVES({
      el: "#vanta-header",
      mouseControls: true,
      touchControls: true,
      gyroControls: false,
      minHeight: 200.00,
      minWidth: 200.00,
      scale: 1.00,
      scaleMobile: 1.00,
      color: 0x4f46e5,
      shininess: 50.00,
      waveHeight: 20.00,
      waveSpeed: 0.50,
      zoom: 0.65
  });

  function updateClock() {
      const now = new Date();
      const hours = String(now.getHours()).padStart(2, '0');
      const minutes = String(now.getMinutes()).padStart(2, '0');
      const seconds = String(now.getSeconds()).padStart(2, '0');
      const dateOptions = { weekday: 'long', day: 'numeric', month: 'long' };
      const date = now.toLocaleDateString('fr-FR', dateOptions);
      
      const clockElement = document.getElementById('clock');
      if (clockElement) {
          clockElement.innerHTML = `<div class="text-xs leading-tight">${date}</div><div class="font-bold">${hours}:${minutes}:${seconds}</div>`;
      }
  }

  function checkConnectionStatus() {
      const statusIndicator = document.getElementById('connection-status');
      if (!statusIndicator) return;
      
      const statusDot = statusIndicator.querySelector('span:first-child');
      const statusText = statusIndicator.querySelector('span:last-child');

      fetch('/')
          .then(response => {
              if (response.ok) {
                  statusDot.classList.remove('bg-red-500');
                  statusDot.classList.add('bg-green-500', 'animate-pulse');
                  statusText.textContent = 'En ligne';
              }
          })
          .catch(() => {
              statusDot.classList.remove('bg-green-500', 'animate-pulse');
              statusDot.classList.add('bg-red-500');
              statusText.textContent = 'Hors ligne';
          });
  }

  document.addEventListener('DOMContentLoaded', function() {
      if (typeof feather !== 'undefined') {
          feather.replace();
      }
      
      setInterval(updateClock, 1000);
      updateClock();

      setInterval(checkConnectionStatus, 15000); // Check every 15 seconds
      checkConnectionStatus();
  });
</script>
</body>
</html>