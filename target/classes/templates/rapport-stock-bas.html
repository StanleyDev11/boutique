<!DOCTYPE html>
<html lang="fr" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard des Stocks</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .kpi-card .card-body {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .kpi-card:hover .card-body {
            transform: translateY(-5px);
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        }
        .pagination .page-item.active .page-link {
            z-index: 1;
        }
    </style>
</head>
<body>

<div th:replace="~{fragments/header :: header}"></div>

<div class="container-fluid mt-4">
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-3">
        <h1 class="h2">Dashboard des Stocks</h1>
    </div>

    <!-- Ligne 1: Cartes de Statistiques -->
    <div class="row mb-4">
        <div class="col-md-6 col-lg-3 mb-3 kpi-card">
            <div class="card h-100 shadow-sm border-warning">
                <div class="card-body d-flex align-items-center">
                    <div class="flex-shrink-0 me-3"><i class="fas fa-box-open fa-3x text-warning"></i></div>
                    <div class="flex-grow-1">
                        <h5 class="card-title">Stock Bas</h5>
                        <p class="h2 fw-bold mb-0" th:text="${nombreStockBas}">0</p>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6 col-lg-3 mb-3 kpi-card">
            <div class="card h-100 shadow-sm border-danger">
                <div class="card-body d-flex align-items-center">
                    <div class="flex-shrink-0 me-3"><i class="fas fa-times-circle fa-3x text-danger"></i></div>
                    <div class="flex-grow-1">
                        <h5 class="card-title">En Rupture</h5>
                        <p class="h2 fw-bold mb-0" th:text="${nombreEnRupture}">0</p>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6 col-lg-3 mb-3 kpi-card">
            <div class="card h-100 shadow-sm border-info">
                <div class="card-body d-flex align-items-center">
                    <div class="flex-shrink-0 me-3"><i class="fas fa-calendar-times fa-3x text-info"></i></div>
                    <div class="flex-grow-1">
                        <h5 class="card-title">Périme Bientôt</h5>
                        <p class="h2 fw-bold mb-0" th:text="${produitsPeremptionProche.size()}">0</p>
                        <small class="text-muted" th:text="'Dans les ' + ${joursAvantPeremption} + ' jours'"></small>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6 col-lg-3 mb-3 kpi-card">
            <div class="card h-100 shadow-sm border-secondary">
                <div class="card-body d-flex align-items-center">
                    <div class="flex-shrink-0 me-3"><i class="fas fa-euro-sign fa-3x text-secondary"></i></div>
                    <div class="flex-grow-1">
                        <h5 class="card-title">Valeur Stock Bas</h5>
                        <p class="h2 fw-bold mb-0" th:text="${#numbers.formatDecimal(valeurStockBas, 1, 'POINT', 2, 'COMMA')}">0</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Ligne 2: Graphiques -->
    <div class="row mb-4">
        <div class="col-lg-8 mb-4">
            <div class="card shadow-sm h-100">
                <div class="card-header">Quantités en Stock Bas (Produits de la page actuelle)</div>
                <div class="card-body"><canvas id="stockChart"></canvas></div>
            </div>
        </div>
        <div class="col-lg-4 mb-4">
            <div class="card shadow-sm h-100">
                <div class="card-header">Statut de Péremption (Total)</div>
                <div class="card-body"><canvas id="peremptionChart"></canvas></div>
            </div>
        </div>
    </div>

    <!-- Ligne 3: Liste des Produits Périmant Bientôt -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-info-subtle">
                    <h5 class="mb-0"><i class="fas fa-calendar-times me-2"></i>Produits Périmant Bientôt (<span th:text="${joursAvantPeremption}"></span> jours)</h5>
                </div>
                <div class="card-body">
                    <div th:if="${produitsPeremptionProche.empty}" class="alert alert-secondary mb-0">Aucun produit n'arrive à péremption dans la période sélectionnée.</div>
                    <div th:unless="${produitsPeremptionProche.empty}" class="table-responsive">
                        <table class="table table-hover table-sm mb-0">
                            <thead><tr><th>Produit</th><th>Date de Péremption</th><th>Jours Restants</th><th>Quantité en Stock</th></tr></thead>
                            <tbody>
                                <tr th:each="produit : ${produitsPeremptionProche}" th:class="${#temporals.day(produit.datePeremption) - #temporals.day(#temporals.createNow()) < 7} ? 'table-danger' : ''">
                                    <td th:text="${produit.nom}"></td>
                                    <td th:text="${#temporals.format(produit.datePeremption, 'dd/MM/yyyy')}"></td>
                                    <td><span class="badge" th:with="joursRestants=${#temporals.day(produit.datePeremption) - #temporals.day(#temporals.createNow())}" th:text="${joursRestants <= 0 ? 'Périmé' : joursRestants + ' jours'}" th:classappend="${joursRestants <= 0} ? 'bg-danger' : (${joursRestants < 7} ? 'bg-warning text-dark' : 'bg-success')"></span></td>
                                    <td th:text="${produit.quantiteEnStock}"></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Ligne 4: Filtres et Liste Stock Bas -->
    <div class="card shadow-sm">
        <div class="card-header">
            <div class="d-flex flex-wrap gap-2 align-items-center">
                <span class="fw-bold me-2">Produits en Stock Bas :</span>
                <a th:href="@{/rapports/stock-bas}" class="btn btn-sm" th:classappend="${activeFilter == null} ? 'btn-primary' : 'btn-outline-secondary'">Afficher tout</a>
                <a th:href="@{/rapports/stock-bas(filter='rupture')}" class="btn btn-sm" th:classappend="${activeFilter == 'rupture'} ? 'btn-danger' : 'btn-outline-secondary'">Filtrer : En rupture</a>
                <div class="vr mx-2 d-none d-md-block"></div>
                <a th:href="@{/rapports/stock-bas(sort='asc', filter=${activeFilter})}" class="btn btn-sm" th:classappend="${sort == 'asc'} ? 'btn-info' : 'btn-outline-secondary'">Trier : Stock Ascendant</a>
                <a th:href="@{/rapports/stock-bas(sort='desc', filter=${activeFilter})}" class="btn btn-sm" th:classappend="${sort == 'desc'} ? 'btn-info' : 'btn-outline-secondary'">Trier : Stock Descendant</a>
            </div>
        </div>
        <div class="card-body">
            <div class="row">
                <div th:if="${produitsPage.empty}" class="col-12"><div class="alert alert-info">Aucun produit correspondant aux critères actuels.</div></div>
                <div th:each="produit : ${produitsPage.content}" class="col-12 col-sm-6 col-md-4 col-lg-3 mb-4">
                    <div th:class="'card h-100 border-2 shadow-sm ' + ${produit.quantiteEnStock == 0 ? 'border-danger bg-danger-subtle' : 'border-warning'}">
                        <div class="card-body d-flex flex-column pb-0">
                            <h5 class="card-title text-center" th:text="${produit.nom}"></h5>
                            <div class="mt-auto text-center">
                                <p class="display-4 fw-bold" th:text="${produit.quantiteEnStock}"></p>
                                <p class="text-muted">en stock</p>
                                <span th:if="${produit.quantiteEnStock == 0}" class="badge bg-danger mb-2">En rupture</span>
                            </div>
                        </div>
                        <div class="card-footer bg-transparent border-0 text-center pt-0"><a th:href="@{/stock/new(produitId=${produit.id})}" class="btn btn-sm btn-success"><i class="fas fa-plus me-1"></i> Ajouter au Stock</a></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="card-footer bg-light" th:if="${produitsPage.totalPages > 1}">
            <nav aria-label="Page navigation">
                <ul class="pagination justify-content-center mb-0">
                    <li class="page-item" th:classappend="${produitsPage.first} ? 'disabled' : ''"><a class="page-link" th:href="@{/rapports/stock-bas(page=${produitsPage.number - 1}, sort=${sort}, filter=${activeFilter})}">Précédent</a></li>
                    <li th:each="i : ${#numbers.sequence(0, produitsPage.totalPages - 1)}" class="page-item" th:classappend="${i == produitsPage.number} ? 'active' : ''"><a class="page-link" th:href="@{/rapports/stock-bas(page=${i}, sort=${sort}, filter=${activeFilter})}" th:text="${i + 1}"></a></li>
                    <li class="page-item" th:classappend="${produitsPage.last} ? 'disabled' : ''"><a class="page-link" th:href="@{/rapports/stock-bas(page=${produitsPage.number + 1}, sort=${sort}, filter=${activeFilter})}">Suivant</a></li>
                </ul>
            </nav>
        </div>
    </div>
</div>

<script th:inline="javascript">
    /*<![CDATA[*/
    document.addEventListener('DOMContentLoaded', function() {
        const produitsPage = /*[[${produitsPage}]]*/ { content: [] };
        const produitsPourGraphique = produitsPage.content;
        const produitsPeremptionProche = /*[[${produitsPeremptionProche}]]*/ [];
        const totalProduits = /*[[${totalProduits}]]*/ 0;

        if (produitsPourGraphique && produitsPourGraphique.length > 0) {
            const stockCtx = document.getElementById('stockChart').getContext('2d');
            new Chart(stockCtx, {
                type: 'bar',
                data: {
                    labels: produitsPourGraphique.map(p => p.nom),
                    datasets: [{
                        label: 'Quantité en Stock',
                        data: produitsPourGraphique.map(p => p.quantiteEnStock),
                        backgroundColor: produitsPourGraphique.map(p => p.quantiteEnStock === 0 ? 'rgba(220, 53, 69, 0.6)' : 'rgba(255, 193, 7, 0.6)'),
                        borderColor: produitsPourGraphique.map(p => p.quantiteEnStock === 0 ? 'rgba(220, 53, 69, 1)' : 'rgba(255, 193, 7, 1)'),
                        borderWidth: 1
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }, plugins: { legend: { display: false } } }
            });
        }

        const peremptionCtx = document.getElementById('peremptionChart').getContext('2d');
        const nbPeremptionProche = produitsPeremptionProche.length;
        const nbAutresProduits = totalProduits - nbPeremptionProche;
        new Chart(peremptionCtx, {
            type: 'doughnut',
            data: {
                labels: ['Périme bientôt', 'Autres produits'],
                datasets: [{
                    data: [nbPeremptionProche, nbAutresProduits],
                    backgroundColor: ['rgba(23, 162, 184, 0.7)', 'rgba(200, 200, 200, 0.5)'],
                    borderColor: ['rgba(23, 162, 184, 1)','rgba(200, 200, 200, 1)'],
                    borderWidth: 1
                }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top' } } }
        });
    });
    /*]]>*/
</script>

</body>
</html>