<!DOCTYPE html>
<html lang="fr" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${pageTitle}"></title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gray-50">

<div th:replace="~{fragments/tailwind-header :: tailwind-header(pageTitle=${pageTitle})}" th:unless="${#strings.equals(view, 'fragment')}"></div>

<!-- Formulaire -->
<div class="w-full px-4 sm:px-6 lg:px-8 py-8" th:classappend="${#strings.equals(view, 'fragment')} ? 'p-0' : ''">

    <div th:fragment="form-content" class="max-w-4xl mx-auto bg-white rounded-lg p-6" th:classappend="${#strings.equals(view, 'fragment')} ? 'shadow-none border-none' : 'shadow-sm border'">
        <h2 class="text-2xl font-bold text-gray-800 mb-6" th:text="${pageTitle}">Titre du Formulaire</h2>

        <form id="user-form" th:action="@{/utilisateurs/save}" th:object="${utilisateur}" method="post">
            <!-- Champ caché pour l'ID -->
            <input type="hidden" th:field="*{id}">

            <!-- Nom d'utilisateur -->
            <div class="mb-4">
                <label for="username" class="block text-sm font-medium text-gray-700 mb-1"><i class="fas fa-user mr-2"></i>Nom d'utilisateur *</label>
                <input type="text" id="username" th:field="*{username}"
                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                       required>
            </div>

            <!-- Mot de passe -->
            <div class="mb-4">
                <label for="password" class="block text-sm font-medium text-gray-700 mb-1">
                    <i class="fas fa-key mr-2"></i>Mot de passe <span th:if="${utilisateur.id == null}" class="text-red-500">*</span>
                </label>
                <input type="password" id="password" th:field="*{password}"
                       th:placeholder="${utilisateur.id != null ? 'Laissez vide pour ne pas changer' : ''}"
                       th:required="${utilisateur.id == null}"
                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                <p class="text-sm text-gray-500 mt-1" th:if="${utilisateur.id != null}">
                    Laissez ce champ vide si vous ne souhaitez pas changer le mot de passe.
                </p>
            </div>

            <!-- Rôles -->
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-2"><i class="fas fa-user-tag mr-2"></i>Rôles *</label>
                <div class="flex flex-wrap gap-4">
                    <div th:each="role : ${allRoles}" class="flex items-center">
                        <input type="checkbox" th:id="${role}" name="roles" th:value="${role}"
                               th:checked="${utilisateur.roles != null && #strings.contains(utilisateur.roles, role)}"
                               class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                        <label th:for="${role}" class="ml-2 block text-sm text-gray-900" th:text="${#strings.replace(role, 'ROLE_', '')}"></label>
                    </div>
                </div>
            </div>

            <!-- Code Caissier -->
            <div id="code-caissier-container" class="mb-4">
                <label for="code" class="block text-sm font-medium text-gray-700 mb-1">
                    <i class="fas fa-barcode mr-2"></i>Code Caissier *
                </label>
                <input type="text" id="code" name="code" th:value="*{code}"
                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            </div>

            <!-- Jeton CSRF (sera géré par JS pour l'AJAX) -->
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

        </form>
    </div>
</div>

<script th:inline="javascript">
    document.addEventListener('DOMContentLoaded', function() {
        const rolesCheckboxes = document.querySelectorAll('input[type="checkbox"][name="roles"]');
        const caissierRoleCheckbox = document.querySelector('input[type="checkbox"][value="ROLE_CAISSIER"]');
        const adminRoleCheckbox = document.querySelector('input[type="checkbox"][value="ROLE_ADMIN"]');
        const gestionnaireRoleCheckbox = document.querySelector('input[type="checkbox"][value="ROLE_GESTIONNAIRE"]');
        const codeCaissierContainer = document.getElementById('code-caissier-container');
        const codeInput = document.getElementById('code');

        function toggleCodeCaissierField() {
            const isCashier = caissierRoleCheckbox && caissierRoleCheckbox.checked;
            const isAdmin = adminRoleCheckbox && adminRoleCheckbox.checked;
            const isManager = gestionnaireRoleCheckbox && gestionnaireRoleCheckbox.checked;

            // Le champ ne s'affiche que si 'CAISSIER' est coché et que les autres ne le sont pas.
            if (isCashier && !isAdmin && !isManager) {
                codeCaissierContainer.style.display = 'block';
                codeInput.setAttribute('required', 'required');
            } else {
                codeCaissierContainer.style.display = 'none';
                codeInput.removeAttribute('required');
                if (codeInput) {
                    codeInput.value = ''; // Clear the value when hidden
                }
            }
        }

        // Initial check on page load
        toggleCodeCaissierField();

        // Add event listener to all role checkboxes
        rolesCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', toggleCodeCaissierField);
        });
    });
</script>

</body>
</html>