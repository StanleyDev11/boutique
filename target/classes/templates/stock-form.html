<!DOCTYPE html>
<html lang="fr" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nouveau Mouvement de Stock</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <style>
        .product-list::-webkit-scrollbar { width: 8px; }
        .product-list::-webkit-scrollbar-track { background: #f8fafc; }
        .product-list::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .product-list::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        [x-cloak] { display: none !important; }
        .quantity-input::-webkit-outer-spin-button,
        .quantity-input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .quantity-input { -moz-appearance: textfield; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

<div th:replace="~{fragments/tailwind-header :: tailwind-header(pageTitle='Nouveau Mouvement de Stock')}"></div>



<div class="w-full px-4 sm:px-6 lg:px-8 py-8" 
     th:attr="data-produits=${produitsJson}"
     x-data="stockForm({ mouvement: /*[[${mouvement.produit}]]*/ null })"
     x-init="init($el.dataset.produits)">


    <form th:action="@{/stock/save}" th:object="${mouvement}" method="post" @submit.prevent="submitForm($event.target)" class="space-y-8">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

            <!-- Left Column: Product List -->
            <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg border border-gray-200/80 flex flex-col" style="height: calc(100vh - 10rem);">
                <h3 class="text-xl font-bold mb-4 flex items-center flex-shrink-0"><i class="fas fa-search mr-3 text-indigo-500"></i>Liste des Produits</h3>
                
                <div class="relative flex-shrink-0 mb-4">
                    <input type="text" x-model="search" placeholder="Nom ou code-barres..."
                           class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition">
                    <i class="fas fa-search text-gray-400 absolute left-3 top-1/2 -translate-y-1/2"></i>
                </div>
                <div class="flex-grow overflow-y-auto product-list pr-2 -mr-2">
                    <ul>
                        <template x-for="product in filteredProducts" :key="product.id">
                            <li @click="selectProduct(product)" 
                                class="flex items-center justify-between p-4 cursor-pointer rounded-lg hover:bg-indigo-50 transition-colors"
                                :class="{'bg-indigo-100': selectedProduct && selectedProduct.id === product.id}">
                                <div>
                                    <p class="font-semibold" x-text="product.name"></p>
                                    <p class="text-sm text-gray-500">Code: <span x-text="product.barcode || 'N/A'"></span></p>
                                </div>
                                <div class="text-right">
                                    <p class="text-sm font-bold text-indigo-600" x-text="product.stock"></p>
                                    <p class="text-xs text-gray-500">en stock</p>
                                </div>
                            </li>
                        </template>
                        <template x-if="filteredProducts.length === 0">
                            <li class="p-4 text-center text-gray-500">Aucun produit trouvé.</li>
                        </template>
                    </ul>
                </div>
            </div>

            <!-- Right Column: Selection & Movement Details -->
            <div class="lg:col-span-2 space-y-8">
                <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200/80 transition-all duration-300"
                     :class="{'opacity-100 scale-100': selectedProduct, 'opacity-50 scale-95': !selectedProduct}">
                    <h3 class="text-xl font-bold mb-4 flex items-center"><i class="fas fa-box-open mr-3 text-indigo-500"></i>Produit Sélectionné</h3>
                    <div x-show="selectedProduct" x-cloak class="space-y-3">
                        <input type="hidden" id="produit" name="produit" x-model="selectedProduct.id">
                        <div>
                            <p class="text-2xl font-bold text-gray-900" x-text="selectedProduct.name"></p>
                            <p class="text-sm text-gray-500">Code-barres: <span x-text="selectedProduct.barcode || 'N/A'"></span></p>
                        </div>
                        <div class="pt-2">
                            <p class="text-sm text-gray-500">Quantité actuelle en stock</p>
                            <p class="text-4xl font-extrabold text-indigo-600" x-text="selectedProduct.stock"></p>
                        </div>
                    </div>
                    <div x-show="!selectedProduct" x-cloak class="text-center py-8">
                        <i class="fas fa-info-circle text-4xl text-gray-300 mb-4"></i>
                        <p class="text-gray-500">Veuillez sélectionner un produit dans la liste de gauche.</p>
                    </div>
                </div>

                <div class="bg-white p-8 rounded-xl shadow-lg border border-gray-200/80">
                    <h3 class="text-2xl font-bold mb-6 flex items-center"><i class="fas fa-dolly-flatbed mr-4 text-indigo-500"></i>Détails du Mouvement</h3>
                    <div class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="typeMouvement" class="block text-sm font-medium text-gray-700 mb-2 flex items-center"><i class="fas fa-exchange-alt mr-2"></i>Type de Mouvement *</label>
                                <div class="relative">
                                    <select id="typeMouvement" th:field="*{typeMouvement}" required class="appearance-none w-full pl-4 pr-10 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 bg-white transition">
                                        <option value="">-- Sélectionner --</option>
                                        <option th:each="type : ${typesMouvement}" th:value="${type}" th:text="${type.libelle}"></option>
                                    </select>
                                    <i class="fas fa-chevron-down text-gray-400 absolute right-4 top-1/2 -translate-y-1/2 pointer-events-none"></i>
                                </div>
                            </div>
                            <div>
                                <label for="quantite" class="block text-sm font-medium text-gray-700 mb-2 flex items-center"><i class="fas fa-cubes mr-2"></i>Quantité *</label>
                                <div class="relative flex items-center">
                                    <button type="button" @click="quantity > 1 ? quantity-- : 1" class="absolute left-0 pl-4 text-gray-500 hover:text-indigo-600 transition"><i class="fas fa-minus-circle text-2xl"></i></button>
                                    <input type="number" id="quantite" th:field="*{quantite}" required min="1" placeholder="0" x-model.number="quantity" class="quantity-input w-full text-center text-xl font-bold px-12 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition">
                                    <button type="button" @click="quantity++" class="absolute right-0 pr-4 text-gray-500 hover:text-indigo-600 transition"><i class="fas fa-plus-circle text-2xl"></i></button>
                                </div>
                            </div>
                        </div>
                        <div>
                            <label for="description" class="block text-sm font-medium text-gray-700 mb-2 flex items-center"><i class="fas fa-pen mr-2"></i>Description (Optionnel)</label>
                            <textarea id="description" th:field="*{description}" rows="5" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition" placeholder="Raison du mouvement, référence, etc."></textarea>
                        </div>
                    </div>
                    
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

                    <div class="flex justify-end space-x-4 pt-8 mt-8 border-t border-gray-200">
                        <a th:href="@{/produits}" class="px-8 py-3 border border-gray-300 text-sm font-medium text-gray-700 rounded-lg hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition-all duration-200 shadow-sm flex items-center"><i class="fas fa-times mr-2"></i>Annuler</a>
                        <button type="submit" :disabled="!selectedProduct" class="px-8 py-3 bg-indigo-600 text-white text-sm font-medium rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-all duration-200 shadow-lg disabled:bg-gray-400 disabled:cursor-not-allowed disabled:shadow-none flex items-center"><i class="fas fa-save mr-2"></i>Enregistrer le Mouvement</button>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

    </body>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script th:inline="javascript">
    /*<![CDATA[*/
    const Toast = Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 3500, timerProgressBar: true, didOpen: (toast) => { toast.addEventListener('mouseenter', Swal.stopTimer); toast.addEventListener('mouseleave', Swal.resumeTimer); } });

    function stockForm(config) {
        return {
            search: '',
            products: [],
            selectedProduct: null,
            quantity: 1,
            barcodeBuffer: '',
            barcodeTimer: null,

            init(produitsJson) {
                this.products = JSON.parse(produitsJson);
                const initialProduct = config.mouvement;
                if (initialProduct) {
                    const productData = this.products.find(p => p.id == initialProduct.id);
                    if (productData) this.selectProduct(productData);
                }
                document.addEventListener('keydown', this.handleKeyDown.bind(this));
            },

            get filteredProducts() {
                if (this.search === '') return this.products;
                return this.products.filter(p =>
                    p.name.toLowerCase().includes(this.search.toLowerCase()) ||
                    (p.barcode && p.barcode.toLowerCase().includes(this.search.toLowerCase()))
                );
            },

            selectProduct(product) {
                this.selectedProduct = product;
            },

            handleKeyDown(e) {
                if (e.key === 'Enter') {
                    if (this.barcodeBuffer.length > 2) this.handleScan(this.barcodeBuffer);
                    this.barcodeBuffer = '';
                    if (document.activeElement.tagName !== 'TEXTAREA') e.preventDefault();
                } else if (e.key.length === 1 && document.activeElement.tagName !== 'INPUT' && document.activeElement.tagName !== 'TEXTAREA') {
                    this.barcodeBuffer += e.key;
                }
                clearTimeout(this.barcodeTimer);
                this.barcodeTimer = setTimeout(() => { this.barcodeBuffer = ''; }, 200);
            },

            handleScan(barcode) {
                const product = this.products.find(p => p.barcode === barcode);
                if (product) {
                    this.selectProduct(product);
                    Toast.fire({ icon: 'success', title: `Produit scanné: ${product.name}` });
                } else {
                    Toast.fire({ icon: 'error', title: 'Produit non trouvé!', text: `Code-barres: ${barcode}` });
                }
            },

            submitForm(form) {
                if (!this.selectedProduct) {
                    Toast.fire({ icon: 'warning', title: 'Veuillez sélectionner un produit.' });
                    return;
                }
                form.submit();
            }
        }
    }
    /*]]>*/
</script>
</html>